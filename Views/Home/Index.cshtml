@{
    ViewBag.Title = "Battle Robot";
}
<style>
 #canvas {
     border: 1px solid black;
 }
</style>

<canvas width="1000px" height="1000px" id="canvas"></canvas>

@section scripts{
    <script>
            // Crea una conexión con tu Hub
            var hub = $.connection.robotHub;

            // Inicia la conexión
            $.connection.hub.start()
                .done(function () {
                    console.log('Now connected, connection ID=' + $.connection.hub.id);
                })
                .fail(function () {
                    console.log('Could not Connect!');
                });

            //Recibes los cambios que ha tenido cada robot
            hub.client.ReceiveNotification = function (infoRobot) {
                var existe = false;

                var newRobot = JSON.parse(infoRobot);
                debugger;
                //Recorremos todos los jugadores
                for (var i = 0; i < jugadores.length; i++) {

                    //Si es un jugador que ya tenemos, obtenemos su posición y la pintamos
                    if (jugadores[i].id == newRobot.id) {
                        contexto.fillStyle = newRobot.color;
                        contexto.fillRect(newRobot.position.x * 50, newRobot.position.y*50, 49, 49);
                        //contexto.drawImage(newRobot.url, newRobot.position.x * 10, newRobot.position.y * 10, 20, 20);


                        //Actualizamos su posición
                        jugadores[i].position.x = newRobot.position.x;
                        jugadores[i].position.y = newRobot.position.y;
                        existe = true;
                    }
                }

                //Si no existe lo creamos
                if (!existe) {
                    jugadores.push(newRobot);
                    //Lo pintamos en la posición que llegue
                    contexto.fillStyle = newRobot.color;
                    contexto.fillRect(newRobot.position.x * 50, newRobot.position.y * 50, 49, 49);
                    //contexto.drawImage(newRobot.url, newRobot.position.x * 10, newRobot.position.y * 10, 20, 20);
                }

            };

            //Limpiar todo el tablero, no debe quedar ninguna celda marcada
            hub.client.ClearAllBoard = function () {
                console.log("ClearAllBoard");
                contexto.fillStyle = "#FFF";
                contexto.fillRect(0, 0, 1000, 1000);
            };

        var robot = {
            id: '1060876',//guid,
            title: 'Esteban González',
            url: 'https://www.vhv.rs/dpng/d/533-5332848_dino-t-rex-chrome-hd-png-download.png',
            color: '#4632a8',
            position: { x: 0, y: 0 },
        };

        var jugadores = [];
        jugadores.push(robot);

        function setPosition(x, y) {
                //de esta manera notificamos a los demás la nueva posición de nuestro robot
                hub.invoke('SendRobotInformation', JSON.stringify(robot));
        }

        //Esto para el movimiento
        document.addEventListener('keydown', (event) => {
            var name = event.key;

            if (name.toUpperCase() == 'W') {
                if (robot.position.y > 0)
                    robot.position.y = robot.position.y - 1;
            } else if (name.toUpperCase() == 'S') {
                if (robot.position.y < 19)
                    robot.position.y = robot.position.y + 1;
            } else if (name.toUpperCase() == 'D') {
                if (robot.position.x < 19)
                    robot.position.x = robot.position.x + 1;
            } else if (name.toUpperCase() == 'A') {
                if (robot.position.x > 0)
                    robot.position.x = robot.position.x - 1;
            }

            contexto.fillStyle = robot.color;
            contexto.fillRect(robot.position.x * 50, robot.position.y * 50, 49, 49);
            //contexto.drawImage(newRobot.url, newRobot.position.x * 10, newRobot.position.y * 10, 20, 20);
            
            setPosition();
        }, false);

        const $canvas = document.querySelector("#canvas");
        const contexto = $canvas.getContext("2d");

        //Definimos la cuadricula
        const cuadricula = [
            []
        ];

        //Llenamos la cuadricula en n x m
        var n = 50;
        var m = 50;
        let y = 0, x = 0;
        const MEDIDA_CUADRO = 25;

        //Primero dibujamos el trablero vacío.
        for (var i = 0; i < n; i++) {
            x = 0;
            for (let j = 0; j < m; j++) {
                // Y creamos el rectángulo en la posición X con Y, usando la misma altura y anchura
                contexto.fillRect(x, y, "#a88132", "#a88132");
                x += MEDIDA_CUADRO;
            }
            y += MEDIDA_CUADRO;
        }

        //Posicionamos el robot en la primera posición
        contexto.fillStyle = robot.color;
        contexto.fillRect(0, 0, 49, 49);
        contexto.drawImage(robot.url, robot.position.x * 50, robot.position.y * 50, 50, 50);

    </script>    
}